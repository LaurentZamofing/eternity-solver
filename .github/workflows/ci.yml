name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test on Java ${{ matrix.java }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: ['11', '17', '21']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java }}
        distribution: 'temurin'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: lib/
        key: ${{ runner.os }}-deps-${{ hashFiles('lib/*.jar') }}

    - name: Compile source
      run: ./compile.sh

    - name: Run tests
      run: ./run_tests.sh

    - name: Test JAR execution
      run: |
        if [ -f "bin/MainCLI.class" ]; then
          echo "✓ Compilation successful"
        else
          echo "✗ Compilation failed"
          exit 1
        fi

  build:
    name: Build JAR
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Build JAR
      run: ./build_jar.sh

    - name: Verify JAR
      run: |
        if [ -f "eternity-solver-1.0.0.jar" ]; then
          echo "✓ JAR created successfully"
          ls -lh eternity-solver-1.0.0.jar
        else
          echo "✗ JAR creation failed"
          exit 1
        fi

    - name: Test JAR execution
      run: |
        java -jar eternity-solver-1.0.0.jar --version
        java -jar eternity-solver-1.0.0.jar --help

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: eternity-solver-jar
        path: eternity-solver-1.0.0.jar
        retention-days: 30

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Check code statistics
      run: |
        echo "=== Source Code Statistics ==="
        find src -name "*.java" | wc -l | xargs echo "Java source files:"
        find src -name "*.java" -exec wc -l {} + | tail -1 | awk '{print "Total source lines: " $1}'

        echo ""
        echo "=== Test Code Statistics ==="
        find test -name "*.java" | wc -l | xargs echo "Test files:"
        find test -name "*.java" -exec wc -l {} + | tail -1 | awk '{print "Total test lines: " $1}'

    - name: Verify documentation
      run: |
        echo "=== Documentation Files ==="
        ls -lh docs/*.md 2>/dev/null || echo "No docs found"
        ls -lh README.md LICENSE .gitignore
